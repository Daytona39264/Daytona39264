name: Claude Code Assistant

on:
  # Trigger 1: PR comment with @claude-code mention
  issue_comment:
    types: [created]

  # Trigger 1: PR review comment with @claude-code mention
  pull_request_review_comment:
    types: [created]

  # Trigger 2: PR labeled with 'claude-code'
  pull_request:
    types: [labeled, opened, synchronize]

  # Trigger 3: Automated on CI failure (optional)
  check_run:
    types: [completed]

jobs:
  claude-code:
    runs-on: ubuntu-latest

    # Only run when:
    # - Comment contains @claude-code, OR
    # - PR has claude-code label, OR
    # - CI check failed (if enabled)
    if: |
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude-code')) ||
      (github.event_name == 'pull_request_review_comment' &&
       contains(github.event.comment.body, '@claude-code')) ||
      (github.event_name == 'pull_request' &&
       contains(github.event.pull_request.labels.*.name, 'claude-code')) ||
      (github.event_name == 'check_run' &&
       github.event.check_run.conclusion == 'failure' &&
       contains(github.event.check_run.name, 'build'))

    permissions:
      contents: write
      pull-requests: write
      issues: write
      checks: read

    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let pr_number;

            if (context.eventName === 'issue_comment') {
              pr_number = context.issue.number;
            } else if (context.eventName === 'pull_request') {
              pr_number = context.payload.pull_request.number;
            } else if (context.eventName === 'check_run') {
              const prs = context.payload.check_run.pull_requests;
              pr_number = prs.length > 0 ? prs[0].number : null;
            }

            if (!pr_number) {
              core.setFailed('Could not determine PR number');
              return;
            }

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });

            core.setOutput('number', pr_number);
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_sha', pr.head.sha);

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g @anthropic-ai/sdk
          # Install GitHub CLI (already available in ubuntu-latest)
          gh --version

      - name: Get trigger context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = ${{ steps.pr.outputs.number }};
            let instruction = '';
            let trigger_type = '';

            if (context.eventName === 'issue_comment') {
              instruction = context.payload.comment.body;
              trigger_type = 'comment';
            } else if (context.eventName === 'pull_request_review_comment') {
              instruction = context.payload.comment.body;
              trigger_type = 'review_comment';
            } else if (context.eventName === 'pull_request') {
              instruction = 'Please review this PR and address any issues.';
              trigger_type = 'label';
            } else if (context.eventName === 'check_run') {
              instruction = 'The CI build is failing. Please fix the errors.';
              trigger_type = 'ci_failure';
            }

            core.setOutput('instruction', instruction);
            core.setOutput('trigger_type', trigger_type);

      - name: Run Claude Code
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          INSTRUCTION: ${{ steps.context.outputs.instruction }}
          TRIGGER_TYPE: ${{ steps.context.outputs.trigger_type }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          node .github/scripts/claude-code-handler.js

      - name: Commit and Push Changes
        id: commit
        run: |
          git config user.name "Claude Code Bot"
          git config user.email "claude-code-bot@users.noreply.github.com"

          if [[ -n $(git status -s) ]]; then
            git add .

            # Create commit message
            cat > /tmp/commit_msg.txt << 'EOF'
          Claude Code: Apply requested changes

          Triggered by: ${{ steps.context.outputs.trigger_type }}
          PR: #${{ steps.pr.outputs.number }}
          Instruction: ${{ steps.context.outputs.instruction }}

          This commit was automatically generated by Claude Code.
          EOF

            git commit -F /tmp/commit_msg.txt
            git push

            echo "changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes committed and pushed"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No changes needed"
          fi

      - name: Comment on PR
        if: steps.commit.outputs.changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = ${{ steps.pr.outputs.number }};
            const trigger_type = '${{ steps.context.outputs.trigger_type }}';

            let comment = 'ü§ñ **Claude Code** has processed your request.\n\n';

            if (trigger_type === 'comment' || trigger_type === 'review_comment') {
              comment += '‚úÖ I\'ve made the requested changes based on your comment.\n\n';
            } else if (trigger_type === 'label') {
              comment += '‚úÖ I\'ve reviewed the PR and made improvements.\n\n';
            } else if (trigger_type === 'ci_failure') {
              comment += '‚úÖ I\'ve attempted to fix the failing CI checks.\n\n';
            }

            comment += 'Please review the changes and let me know if you need any adjustments.\n\n';
            comment += '_Powered by [Claude Code](https://github.com/anthropics/anthropic-sdk-typescript)_';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              body: comment
            });

      - name: Report failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = ${{ steps.pr.outputs.number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              body: '‚ùå **Claude Code** encountered an error while processing your request.\n\nPlease check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            });
